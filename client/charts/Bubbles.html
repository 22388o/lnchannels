<!-- @format -->

<script>
  import {onMount, onDestroy} from 'svelte'

  export let channels

  var el
  var chart

  onMount(() => {
    var bubbledata = []

    for (let i = channels.length - 1; i >= 0; i--) {
      let chan = channels[i]

      if (!chan.onchain.close.block) {
        // if it's open add to bubble chart
        bubbledata.push({
          x: chan.onchain.open.block,
          y: chan.satoshis,
          z: chan.peer.size,
          name: chan.peer.name,
          scid: chan.short_channel_id
        })
      }
    }

    // channel bubbles
    chart = H.chart(el, {
      title: {text: ''},
      yAxis: [{title: {text: 'channel size (sat)', enabled: null}, floor: 0}],
      series: [
        {
          type: 'bubble',
          data: bubbledata,
          marker: {fillColor: 'var(--gold)'},
          showInLegend: false,
          minSize: '1%',
          maxSize: '30%',
          sizeBy: 'width',
          dataLabels: {
            enabled: true,
            format: '{point.name}',
            style: {
              color: 'black',
              textOutline: 'none',
              fontWeight: 'normal'
            }
          },
          tooltip: {
            headerFormat: '',
            followPointer: true,
            followTouchMove: true,
            pointFormat: '{point.name}: {point.y}',
            valueSuffix: ' sat'
          },
          events: {
            click: e => {
              document.getElementById(`ch-${e.point.scid}`).scrollIntoView({
                behavior: 'smooth',
                block: 'start',
                inline: 'nearest'
              })
            }
          }
        }
      ]
    })
  })

  onDestroy(() => {
    chart.destroy()
  })
</script>

<div>
  <h4>current channels</h4>
  <div bind:this="{el}" />
</div>
