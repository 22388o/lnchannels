<!-- @format -->

<script>
  import {onMount, onDestroy, getContext} from 'svelte'
  import {plotOptions} from '../helpers'

  const first_block = getContext('first_block')

  var el
  var chart

  var blocks = []
  export var chartType = 'counts' // or 'sizes'
  var chartAggregates = {
    counts: {
      unknown: [],
      unused: [],
      mutual: [],
      force: [],
      force_unused: [],
      penalty: []
    },
    sizes: {
      unknown: [],
      unused: [],
      mutual: [],
      force: [],
      force_unused: [],
      penalty: []
    }
  }

  function toggle(e) {
    e.preventDefault()
    chartType = chartType === 'counts' ? 'sizes' : 'counts'
    buildChart()
  }

  function buildChart() {
    if (chart) chart.destroy()

    chart = H.chart(el, {
      title: {text: ''},
      chart: {type: 'areaspline'},
      xAxis: {
        categories: blocks.map(b => b.toString().slice(0, -2) + '__')
      },
      yAxis: [
        {visible: false},
        {visible: false},
        {visible: false},
        {visible: false},
        {visible: false}
      ],
      series: [
        ['unknown', '#e4dfda'],
        ['unused', 'var(--green)'],
        ['mutual', 'var(--blue)'],
        ['force', '#f58f29'],
        ['force_unused', '#7d4600'],
        ['penalty', 'var(--red)']
      ].map(([name, color]) => ({
        name,
        data: chartAggregates[chartType][name],
        color
      })),
      plotOptions: {...plotOptions, areaspline: {stacking: 'percent'}}
    })
  }

  onMount(async () => {
    let data = await (
      await fetch(`/api/closetypes?blockgroup=gt.${first_block}`, {
        headers: {
          'Range-Unit': 'items',
          Range: '1-'
        }
      })
    ).json()

    for (let i = 0; i < data.length; i++) {
      let ct = data[i]
      blocks.push(ct.blockgroup)
      chartAggregates.counts.unknown.push(ct.unknown.c)
      chartAggregates.counts.unused.push(ct.unused.c)
      chartAggregates.counts.mutual.push(ct.mutual.c)
      chartAggregates.counts.force.push(ct.force.c)
      chartAggregates.counts.force_unused.push(ct.force_unused.c)
      chartAggregates.counts.penalty.push(ct.penalty.c)
      chartAggregates.sizes.unknown.push(ct.unknown.s)
      chartAggregates.sizes.unused.push(ct.unused.s)
      chartAggregates.sizes.mutual.push(ct.mutual.s)
      chartAggregates.sizes.force.push(ct.force.s)
      chartAggregates.sizes.force_unused.push(ct.force_unused.s)
      chartAggregates.sizes.penalty.push(ct.penalty.s)
    }

    buildChart()
  })

  onDestroy(() => {
    chart.destroy()
  })
</script>

<div>
  <h4>
    types of channel closes (by
    <span class="toggle" on:click="{toggle}">{chartType}</span>)
  </h4>
  <div bind:this="{el}" />
</div>
