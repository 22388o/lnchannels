<!-- @format -->

<script>
  import {onMount, getContext} from 'svelte'
  import {abbr, date} from './helpers'
  import NotFound from './NotFound.html'

  var notfound = false
  var channel = {
    short_channel_id: 'loading',
    nodes: ['', ''],
    names: ['', ''],
    onchain: {open: {}, close: {}}
  }
  var upwardpolicies = []
  var downwardpolicies = []
  var stats = {}

  const id = getContext('history')
    .location.pathname.split('/')
    .slice(-1)[0]

  onMount(async () => {
    stats = await getContext('stats')
  })

  onMount(async () => {
    let res = await (
      await fetch(`/api/channels?short_channel_id=eq.${id}`)
    ).json()
    if (res.length === 0) {
      notfound = true
    } else {
      channel = res[0]
      channel.names = channel.nodes.map(abbr)
      fetchAlias(channel.nodes[0])
      fetchAlias(channel.nodes[1])
    }
  })

  async function fetchAlias(nodeidx) {
    let pubkey = channel.nodes[nodeidx]

    let res = await (
      await fetch(
        `/api/nodealiases?pubkey=eq.${pubkey}&select=alias&order=last_seen.desc`,
        {
          headers: {
            'Range-Unit': 'items',
            Range: '0-1'
          }
        }
      )
    ).json()
    if (res.length) {
      channel.aliases[nodeidx] = res[0].alias
    }
  }

  onMount(async () => {
    let policies = await (
      await fetch(
        `/api/policies?short_channel_id=eq.${id}&select=direction,base_fee_millisatoshi,fee_per_millionth,delay,update_time`
      )
    ).json()

    for (let i = 0; i < policies.length; i++) {
      let policy = policies[i]
      ;[downwardpolicies, upwardpolicies][policy.direction].push(policy)
    }
  })
</script>

<svelte:head>
  <title>channel {channel.short_channel_id}</title>
  <meta
    name="description"
    content="Information about the Lightning Network channel {channel.short_channel_id} between {channel.names[0]} and {channel.names[1]}"
  />
</svelte:head>

{#if notfound}
<NotFound />
{:else}
<div>
  <h1>
    channel
    <pre class="id" class:closed="{channel.onchain.close.block}">
    {channel.short_channel_id}
  </pre
    >
  </h1>

  <h4>details</h4>
  <table>
    <tr>
      <th>short_channel_id</th>
      <td>{channel.short_channel_id}</td>
    </tr>
    <tr>
      <th>satoshis</th>
      <td>{channel.satoshis}</td>
    </tr>
    <tr>
      <th>nodes</th>
      <td>
        <table>
          <tr>
            <td>
              {channel.names[0]}
            </td>
            <td>
              {channel.names[1]}
            </td>
          </tr>
          <tr>
            <td>
              <a href="/node/{channel.nodes[0]}">{abbr(channel.nodes[0])}</a>
            </td>
            <td>
              <a href="/node/{channel.nodes[1]}">{abbr(channel.nodes[1])}</a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <th>duration</th>
      <td>
        {#if channel.onchain.close.block} {channel.onchain.close.block -
        channel.onchain.open.block} blocks
        <i
          class="bar"
          style="width:{100 * (channel.onchain.close.block - channel.onchain.open.block) / stats.max_channel_duration}%; background: var(--gold)"
        />
        {:else} {stats.last_block - channel.onchain.open.block} blocks and
        counting
        <i
          class="bar"
          style="width:{100 * (stats.last_block - channel.onchain.open.block) / stats.max_channel_duration}%; background: var(--gold)"
        />
        {/if}
      </td>
    </tr>
  </table>

  {#if upwardpolicies.length || downwardpolicies.length}
  <h4>policy details</h4>
  <div style="display: flex">
    {#if upwardpolicies.length}
    <table>
      <caption>
        from
        <code>
          {channel.names[0]}
        </code>
      </caption>
      <thead>
        <tr>
          <th>min fee</th>
          <th>fee %</th>
          <th>delay</th>
          <th>update</th>
        </tr>
      </thead>
      <tbody>
        {#each upwardpolicies as policy}
        <tr>
          <td>{policy.base_fee_millisatoshi / 1000} sat</td>
          <td>{policy.fee_per_millionth / 10000}</td>
          <td>{policy.delay}</td>
          <td>{date(policy.update_time)}</td>
        </tr>
        {/each}
      </tbody>
    </table>
    {/if} {#if downwardpolicies.length}
    <table>
      <caption>
        from
        <code>
          {channel.names[1]}
        </code>
      </caption>
      <thead>
        <tr>
          <th>min fee</th>
          <th>fee %</th>
          <th>delay</th>
          <th>update</th>
        </tr>
      </thead>
      <tbody>
        {#each downwardpolicies as policy}
        <tr>
          <td>{policy.base_fee_millisatoshi / 1000} sat</td>
          <td>{policy.fee_per_millionth / 10000}</td>
          <td>{policy.delay}</td>
          <td>{date(policy.update_time)}</td>
        </tr>
        {/each}
      </tbody>
    </table>
    {/if}
  </div>
  {:else}
  <br />
  {/if}

  <h4>onchain transactions</h4>
  <table>
    <tr>
      <th></th>
      <th>block</th>
      <th>transaction</th>
      <th>fee paid</th>
    </tr>
    <tr>
      <th>open</th>
      <td>
        <a
          href="https://blockstream.info/block/{channel.onchain.open.block}"
          title="{channel.onchain.open.time}"
        >
          {channel.onchain.open.block}
        </a>
      </td>
      <td>
        <a
          href="https://blockstream.info/tx/{channel.onchain.open.txid}?output:{channel.short_channel_id.split('x')[2]}"
        >
          {channel.onchain.open.txid}
        </a>
      </td>
      <td>{channel.onchain.open.fee} sat</td>
    </tr>
    {#if channel.onchain.close.block}
    <tr>
      <th>close</th>
      <td>
        <a
          href="https://blockstream.info/block/{channel.onchain.close.block}"
          title="{channel.onchain.close.time}"
        >
          {channel.onchain.close.block}
        </a>
      </td>
      <td>
        <a href="https://blockstream.info/tx/{channel.onchain.close.txid}">
          {channel.onchain.close.txid}
        </a>
        {#if channel.onchain.close.type}
        <div>close type: <strong>{channel.onchain.close.type}</strong></div>
        {#if channel.onchain.close.htlcs.a.length +
        channel.onchain.close.htlcs.b.length > 0}
        <div>
          outstanding HTLCs: {channel.channel.onchain.close.htlcs.a.length +
          channel.onchain.close.htlcs.b.length}
        </div>
        {/if}
        <div>
          <em>{channel.onchain.close.balance.a} sat</em> â†¹
          <em>{channel.onchain.close.balance.b} sat</em>
        </div>
        {/if}
      </td>
      <td>{channel.onchain.close.fee} sat</td>
    </tr>
    {/if}
  </table>
</div>
{/if}
