<!-- @format -->

<script>
  import {abbr} from './helpers'

  export let pubkey
  export let link = false

  var namePromise = Promise.resolve(pubkey)

  $: if (pubkey !== '') {
    if (pubkey in window.namePromises) {
      namePromise = window.namePromises[pubkey]
    } else {
      namePromise = new Promise(async (resolve, reject) => {
        let res = await (
          await fetch(
            `/api/nodealiases?pubkey=eq.${pubkey}&select=alias&order=last_seen.desc`,
            {
              headers: {
                'Range-Unit': 'items',
                Range: '0-1'
              }
            }
          )
        ).json()

        if (res.length && res[0].alias != '') {
          resolve(res[0].alias)
          return
        }

        reject('not found, someone please catch this')
      })

      window.namePromises[pubkey] = namePromise
    }
  }
</script>

{#if link}
<a href="/node/{pubkey}">
  {#await namePromise}{pubkey}{:then name}{name}{:catch
  error}{abbr(pubkey)}{/await}
</a>
{:else}
<span>
  {#await namePromise}{pubkey}{:then name}{name}{:catch
  error}{abbr(pubkey)}{/await}
</span>
{/if}
