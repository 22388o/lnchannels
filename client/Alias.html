<!-- @format -->

<script>
  import {abbr} from './helpers'

  export let pubkey
  export let link = false

  var el
  var aliasPromise = Promise.resolve({alias: pubkey})

  $: if (pubkey !== '') {
    if (pubkey in window.aliasPromises) {
      aliasPromise = window.aliasPromises[pubkey]
    } else {
      aliasPromise = new Promise(async (resolve, reject) => {
        let res = await (
          await fetch(
            `/api/nodealiases?pubkey=eq.${pubkey}&select=alias,color&order=first_seen.desc`,
            {
              headers: {
                'Range-Unit': 'items',
                Range: '0-1'
              }
            }
          )
        ).json()

        if (res.length === 0) {
          reject('not found, someone please catch this')
          return
        }

        console.log(res[0].color)
        if (res[0].color) {
          el.style.setProperty('--nodecolor', `#${res[0].color}`)
        }

        if (res.length && res[0].alias != '') {
          resolve(res[0])
          return
        }

        reject('should never happen')
      })

      window.aliasPromises[pubkey] = aliasPromise
    }
  }
  $: namePromise = aliasPromise.then(a => a.alias)
</script>

<style>
  .name::after {
    content: ' ';
    transition: color 300ms linear;
    border-radius: 85px;
    display: inline-block;
    margin-left: 4px;
    height: 9px;
    width: 9px;
    position: relative;
    top: 1px;
    background: var(--nodecolor);
  }
</style>

{#if link}
<a href="/node/{pubkey}" class="name" bind:this="{el}">
  {#await namePromise}{pubkey}{:then name}{name}{:catch
  error}{abbr(pubkey)}{/await}
</a>
{:else}
<span class="name" bind:this="{el}">
  {#await namePromise}{pubkey}{:then name}{name}{:catch
  error}{abbr(pubkey)}{/await}
</span>
{/if}
